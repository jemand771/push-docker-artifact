name: artifact-push
description: Push docker image workflow artifacts to ghcr
inputs:
  GITHUB_TOKEN:
    description: Token for accessing ghcr. Set to github.token. Omit to disable docker login.
    required: false
runs:
  using: composite
  steps:
    - name: Print related workflow
      run: |
        echo This upload refers to $(echo ${{ github.event.workflow_run.artifacts_url }} | sed s/api.github.com/github.com/ | sed s+/repos/+/+ | sed s+/artifacts++)
        echo Title: ${{ toJson(github.event.workflow_run.display_title) }}
      shell: bash
    - name: Update podman
      # via https://podman.io/docs/installation
      # language=bash
      run: |
        sudo mkdir -p /etc/apt/keyrings
        # Debian Testing/Bookworm
        curl -fsSL https://download.opensuse.org/repositories/devel:kubic:libcontainers:unstable/Debian_Testing/Release.key \
        | gpg --dearmor \
        | sudo tee /etc/apt/keyrings/devel_kubic_libcontainers_unstable.gpg > /dev/null
        echo \
        "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/devel_kubic_libcontainers_unstable.gpg]\
        https://download.opensuse.org/repositories/devel:kubic:libcontainers:unstable/Debian_Testing/ /" \
        | sudo tee /etc/apt/sources.list.d/devel:kubic:libcontainers:unstable.list > /dev/null
        sudo apt update
        sudo apt install -y podman
      shell: bash
    - name: Login to GitHub Container Registry
      uses: docker/login-action@v2
      if: ${{ inputs.GITHUB_TOKEN != '' }}
      with:
        registry: ghcr.io
        username: ${{ github.repository_owner }}
        password: ${{ inputs.GITHUB_TOKEN }}
    - name: Download images
      uses: actions/github-script@v6.4.1
      with:
        # language=javascript
        script: |
          var artifacts = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: ${{github.event.workflow_run.id }},
          });
          var matchArtifact = artifacts.data.artifacts.filter((artifact) => {
            return artifact.name == "docker-images"
          })[0];
          var download = await github.rest.actions.downloadArtifact({
              owner: context.repo.owner,
              repo: context.repo.repo,
              artifact_id: matchArtifact.id,
              archive_format: 'zip',
          });
          var fs = require('fs');
          fs.writeFileSync('${{github.workspace}}/docker-images.zip', Buffer.from(download.data));
    - run: unzip docker-images.zip
      shell: bash
    - name: import images
      run: for file in *.tar; do echo "loading $file"; podman load < $file; done
      shell: bash
    - run: podman image ls && podman --version
      shell: bash
    - name: push all images
      run: for image in $(cat docker-images.txt); do echo pushing $image; podman push $image; done
      shell: bash
